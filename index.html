<!DOCTYPE html>
<html lang="en">
<head>
  <script src="js/hello.all.js"></script>
  <script src="js/proxapi.js"></script>
  <title>Twitterviz</title>
  <meta charset="UTF-8">
</head>
<body>
<button id='login' onclick="hello.login('twitter');">Twitter</button>
<button id='others' onclick='ensuite();'>Ensuite</button>
<div id="result"></div>
<script>
hello.on('auth.login', function(r){
  // Get Profile
  hello.api(r.network+':/me', function(p){
    document.getElementById('login').innerHTML = "<img src='"+ p.thumbnail + "' width=24/>Connected to "+ r.network+" as " + p.name;
  });
});

var twitterProxy = new ProxAPI({
  retryDelay: 60*5,
  translate: function(params, handleResults){
    var status = {
      quota: false
    };

    hello("twitter").api("me/followers", function(r){
      console.log('from hello:');
      console.log(r);
  // .get("followers/list", {screen_name: params.twitter_account, count: 50, cursor: params.cursor}, function (err, data, response) {
        // if (response.statusCode === 429 || (err && err.message === "Rate limit exceeded")){
        //   err = null;
        //   status.quota = true;
        //   status.retryDelay = response.headers['x-rate-limit-reset'] - (Date.now()/1000) ;
        // }
        // handleResults(err, data, status);
        handleResults(null, r, status);
    });
  }
});

function ensuite(){
  console.log('ensuite...');

  var params = {
    twitter_account: "mmai",
    cursor: -1
  };

  var options = {
    strategy: "retry",
    onEvent: function(eventName, data){
      if (eventName === "retrying"){
        console.log(data);
      }
    }
  };

  var callSettings = {
    endCondition: function(err, data){
      return (data.next_cursor_str == '0');
    },
    newParams: function(error, data, params){
      return {
        twitter_account: params.twitter_account,
        cursor: data.next_cursor_str
      };
    },
    aggregate: function(acc, res){
      return acc.concat(res.users);
    }
  };

  twitterProxy.callUntil(params, options, function(err, data){
    console.log("Total followers: " + data.length);
  }, callSettings);
}

hello.init({
  'twitter' : 'kY8RNvNTeEbaier9Q48BJQIOH'
}, {
  redirect_uri:'redirect.html',
  oauth_proxy: 'https://auth-server.herokuapp.com/proxy'
});
</script>

</body>
</html>
